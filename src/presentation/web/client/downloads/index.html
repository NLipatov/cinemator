<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cinemator ‚Äì Downloads</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <div class="theme-toggle" id="themeToggle" title="Switch theme">
    <span class="icon" id="icon-moon" style="display:none">üåô</span>
    <span class="icon" id="icon-sun"  style="display:none">‚òÄÔ∏è</span>
  </div>

  <div class="card">
    <h2>Cinemator ‚Äì Current Downloads</h2>
    <ul class="download-list">
      <!-- JS will populate real data -->
      <li class="download-item" data-expire="2025-06-20T14:00:00Z">
        <div class="info">
        </div>
        <button class="btn-delete">Delete</button>
      </li>
    </ul>
    <div class="msg" id="downloadsMsg"></div>
  </div>
  <script src="../index.js"></script>
  <script>
    // convert UTC ‚Üí local
    document.querySelectorAll('.download-item').forEach(item => {
      const dt = new Date(item.dataset.expire);
      item.querySelector('.expire-time').textContent = dt.toLocaleString();
    });
    // TODO: fetch("/api/downloads") ‚Üí build list + bind .btn-delete
  </script>
  <script>
    async function loadDownloads() {
      const msgEl = document.getElementById("downloadsMsg");
      msgEl.textContent = ""; 
  
      try {
        const res = await fetch("/api/downloads");
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const list = await res.json(); // [{ name, sizeGB }, ...]
  
        const ul = document.querySelector(".download-list");
        ul.innerHTML = ""; // clear any template
  
        if (list.length === 0) {
          msgEl.textContent = "No current downloads";
          return;
        }
  
        list.forEach(item => {
          const li       = document.createElement("li");
          li.className   = "download-item";
          const info     = document.createElement("div");
          info.className = "info";
  
          const name     = document.createElement("span");
          name.className = "name";
          name.textContent = item.name;
  
          const size     = document.createElement("span");
          size.className = "size";
          size.textContent = `${item.sizeGB.toFixed(2)} GB`;
  
          const expires  = document.createElement("span");
          expires.className = "expires";
          const tm       = document.createElement("time");
          tm.textContent = new Date(item.expire || Date.now()).toLocaleString();
          expires.textContent = "Expires: ";
          expires.append(tm);
  
          const btnDel   = document.createElement("button");
          btnDel.className = "btn-delete";
          btnDel.textContent = "Delete";
  
          info.append(name, size, expires);
          li.append(info, btnDel);
          ul.append(li);
  
          btnDel.onclick = async () => {
            if (!confirm(`Delete "${item.name}"?`)) return;
            const del = await fetch(`/api/downloads/${encodeURIComponent(item.name)}`, { method: "DELETE" });
            if (del.ok) li.remove();
            else alert("Delete failed: " + del.statusText);
          };
        });
      } catch (err) {
        msgEl.textContent = "Error: " + err.message;
      }
    }
  
    window.addEventListener("DOMContentLoaded", loadDownloads);
  </script>
</body>
</html>
